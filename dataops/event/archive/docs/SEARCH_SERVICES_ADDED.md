# Search Services Added to data_foundation.template.sql

## Summary

Successfully integrated all Cortex Search Services from Notebook 4 into the `data_foundation.template.sql` script. The script now creates a complete FSI AI Assistant environment including semantic search capabilities.

## What Was Added

### 1. New Base Tables (with data loading)
- **call_embeds** (317 rows)
  - Chunked earnings call transcripts for search
  - Excludes EMBED vector column (regenerated by search service)
  - Data: `call_embeds.csv`

- **EMAIL_PREVIEWS_EXTRACTED** (660 rows)
  - Email content with extracted metadata
  - Includes ticker, rating, sentiment attributes
  - Data: `email_previews_extracted.csv`

### 2. Derived Tables
- **FULL_TRANSCRIPTS**
  - Created from call_embeds
  - Includes URL placeholder column
  - Used by `snow_full_earnings_calls` search service

- **URL columns added to existing tables**:
  - ANALYST_REPORTS (URL column added)
  - INFOGRAPHICS_FOR_SEARCH (URL column added)

### 3. Five Cortex Search Services

#### 1. dow_analysts_sentiment_analysis
- **Purpose**: Search earnings call transcripts with analyst sentiment
- **Search Field**: FULL_TRANSCRIPT_TEXT
- **Attributes**: primary_ticker, unique_analyst_count, sentiment_score, sentiment_reason
- **Source**: SENTIMENT_WITH_TRANSCRIPTS_FOR_SEARCH + unique_transcripts

#### 2. snow_full_earnings_calls
- **Purpose**: Search chunked Snowflake earnings calls
- **Search Field**: TEXT
- **Attributes**: URL, SENTIMENT_SCORE, SENTIMENT, SUMMARY, RELATIVE_PATH
- **Source**: FULL_TRANSCRIPTS

#### 3. ANALYST_REPORTS_SEARCH
- **Purpose**: Search analyst report content
- **Search Field**: FULL_TEXT
- **Attributes**: URL, NAME_OF_REPORT_PROVIDER, DOCUMENT_TYPE, DOCUMENT, SUMMARY, RELATIVE_PATH, RATING, DATE_REPORT
- **Source**: ANALYST_REPORTS

#### 4. INFOGRAPHICS_SEARCH
- **Purpose**: Search infographic summaries and KPI data
- **Search Field**: BRANDING
- **Attributes**: URL, COMPANY_TICKER, RELATIVE_PATH, TEXT, COMPANY_NAME, REPORT_PERIOD, TICKER
- **Source**: INFOGRAPHICS_FOR_SEARCH

#### 5. EMAILS
- **Purpose**: Search email content and metadata
- **Search Field**: HTML_CONTENT
- **Attributes**: TICKER, RATING, SENTIMENT, SUBJECT, CREATED_AT, RECIPIENT_EMAIL
- **Source**: EMAIL_PREVIEWS_EXTRACTED

### 4. Optional Tasks (Commented Out)

Three tasks are provided (commented out) to refresh presigned URLs every 5 days:
- `refresh_full_transcripts_task`
- `refresh_analyst_reports_url_task`
- `refresh_infographics`

**Note**: These tasks require file stages to be set up:
- @DOCUMENT_AI.EARNINGS_CALLS
- @DOCUMENT_AI.ANALYST_REPORTS
- @DOCUMENT_AI.INFOGRAPHICS

Tasks can be enabled by uncommenting the section and ensuring stages exist.

## Data Export Details

### Total Data Exported
- **12 CSV files** total
- **3,712 total rows** exported across all tables
- **3.5 MB** total data size

### Files Added for Search Services
1. `call_embeds.csv` - 317 rows, 424 KB
2. `email_previews_extracted.csv` - 660 rows, 1.8 MB

## Script Structure

The additions were made at the end of `data_foundation.template.sql` in this order:

1. **Lines 1175-1200**: Table definitions for call_embeds and EMAIL_PREVIEWS_EXTRACTED
2. **Lines 1202-1284**: Data loading scripts for the two new tables
3. **Lines 1286-1319**: Creation of derived tables (FULL_TRANSCRIPTS) and URL column additions
4. **Lines 1321-1388**: Creation of 5 Cortex Search Services
5. **Lines 1390-1436**: Optional task definitions (commented out)
6. **Lines 1438-1448**: Verification queries and SHOW commands

## Deployment Impact

When `data_foundation.template.sql` is deployed, it will:
1. ✅ Create all 12 base tables
2. ✅ Load all 3,712 rows of data
3. ✅ Create all dependent views
4. ✅ Create all 5 Cortex Search Services
5. ✅ Set up URL placeholder columns
6. ✅ Verify row counts and list search services

## Integration with Cortex Agent

These search services are designed to be used by a Cortex Agent (created in later notebooks) to:
- Search earnings call transcripts for sentiment analysis
- Find relevant analyst reports
- Locate specific infographic data points
- Search through email communications
- Provide context-aware responses using multiple data sources

## Prerequisites

- **Cortex Search Service privilege**: User needs CORTEX_USER role or appropriate privileges
- **Warehouse**: Specified by {{ env.EVENT_WAREHOUSE }}
- **Database and Schema**: Specified by {{ env.EVENT_DATABASE }} and {{ env.EVENT_SCHEMA }}

## Testing Search Services

After deployment, test the search services:

```sql
-- Test analyst sentiment search
SELECT SNOWFLAKE.CORTEX.SEARCH_PREVIEW(
    'ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA.dow_analysts_sentiment_analysis',
    '{"query": "What did analysts say about revenue growth?"}'
);

-- Test email search
SELECT SNOWFLAKE.CORTEX.SEARCH_PREVIEW(
    'ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA.EMAILS',
    '{"query": "stock recommendations", "filters": {"@eq": {"RATING": "Buy"}}}'
);
```

## Notes

- Vector embeddings (EMBED column) are automatically generated by Cortex Search Services
- URL placeholders can be replaced with actual presigned URLs if file stages are configured
- Search services use TARGET_LAG = '1 hour' for automatic refresh
- All search services are schema-qualified for easy reference


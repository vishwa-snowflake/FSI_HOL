-- Test script for data foundation components on test instance
USE ROLE ACCOUNTADMIN;
USE WAREHOUSE DEFAULT_WH;
USE DATABASE ACCELERATE_AI_IN_FSI;
USE SCHEMA DEFAULT_SCHEMA;

-- Test 1: Create network rule
CREATE OR REPLACE NETWORK RULE ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA.SNOWFLAKE_INTELLIGENCE_WEBACCESS_RULE
  MODE = EGRESS
  TYPE = HOST_PORT
  VALUE_LIST = ('0.0.0.0:80', '0.0.0.0:443');

-- Test 2: Create external access integration
CREATE OR REPLACE EXTERNAL ACCESS INTEGRATION SNOWFLAKE_INTELLIGENCE_EXTERNALACCESS_INTEGRATION
  ALLOWED_NETWORK_RULES = (ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA.SNOWFLAKE_INTELLIGENCE_WEBACCESS_RULE)
  ENABLED = true;

-- Test 3: Create email notification integration
CREATE OR REPLACE NOTIFICATION INTEGRATION snowflake_intelligence_email_int
  TYPE=EMAIL
  ENABLED=TRUE;

-- Test 4: Create EMAIL_PREVIEWS table
CREATE TABLE IF NOT EXISTS ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA.EMAIL_PREVIEWS (
    EMAIL_ID VARCHAR(100) PRIMARY KEY,
    RECIPIENT_EMAIL VARCHAR(500),
    SUBJECT VARCHAR(1000),
    HTML_CONTENT VARCHAR(16777216),
    CREATED_AT TIMESTAMP_NTZ
);

-- Test 5: Insert sample emails using SELECT with UNION ALL
INSERT INTO ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA.EMAIL_PREVIEWS (EMAIL_ID, RECIPIENT_EMAIL, SUBJECT, HTML_CONTENT, CREATED_AT) 
SELECT 'EMAIL_001', 'test@example.com', 'Test Email 1', 
'<html><body><h1>Test Email</h1><p>This is a test.</p></body></html>', 
TIMESTAMP_NTZ_FROM_PARTS(2024, 11, 20, 15, 30, 0)

UNION ALL

SELECT 'EMAIL_002', 'test2@example.com', 'Test Email 2',
'<html><body><h1>Test Email 2</h1><p>Another test.</p></body></html>',
TIMESTAMP_NTZ_FROM_PARTS(2024, 9, 15, 9, 0, 0);

-- Test 6: Verify emails inserted
SELECT EMAIL_ID, RECIPIENT_EMAIL, SUBJECT, CREATED_AT 
FROM ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA.EMAIL_PREVIEWS 
ORDER BY CREATED_AT DESC;

-- Test 7: Show integrations
SHOW INTEGRATIONS LIKE 'SNOWFLAKE_INTELLIGENCE%';
SHOW NETWORK RULES IN ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA;

SELECT 'All tests completed successfully!' as STATUS;


# SnowMail Native App

## Overview

SnowMail is a Gmail-style email viewer packaged as a Snowflake Native Application. It provides a professional, standalone interface for viewing email reports generated by Snowflake Intelligence Portfolio Analytics agents.

## Structure

```
native_app_snowmail/
‚îú‚îÄ‚îÄ manifest.yml           # App manifest defining version and artifacts
‚îú‚îÄ‚îÄ setup.sql             # Installation script (creates schema, roles, Streamlit)
‚îú‚îÄ‚îÄ streamlit/
‚îÇ   ‚îî‚îÄ‚îÄ email_viewer.py   # Main Streamlit application
‚îî‚îÄ‚îÄ README.md             # This file
```

## Deployment

### Automatic Deployment (Pipeline)

SnowMail is automatically deployed via the DataOps pipeline:

**Pipeline Job**: `Deploy SnowMail Native App`  
**Stage**: Additional Configuration  
**Template**: `dataops/event/healthcare/deploy_snowmail_native_app.template.sql`  
**Pipeline Config**: `pipelines/includes/local_includes/deploy_snowmail_native_app.yml`

The pipeline:
1. Creates stage infrastructure
2. Uploads manifest.yml, setup.sql, and email_viewer.py
3. Registers app version
4. Creates/upgrades application instance
5. Grants necessary permissions

### Manual Deployment

If you need to deploy manually:

```bash
# Navigate to project root
cd /path/to/healthcare

# Run the deployment script
dataops-templater \
  --pattern "dataops/event/healthcare/deploy_snowmail_native_app.template.sql" \
  --output "./output" \
  --ignore-missing-env-vars

snow sql \
  --connection your_connection \
  --filename "./output/dataops/event/healthcare/deploy_snowmail_native_app.template.sql"
```

## Components

### Application Package

- **Name**: `SNOWMAIL_PKG`
- **Database**: `ACCELERATE_AI_IN_FSI_SNOWMAIL_PKG`
- **Stage**: `ACCELERATE_AI_IN_FSI_SNOWMAIL_PKG.APP_CODE.SNOWMAIL_STAGE`

### Application Instance

- **Name**: `SNOWMAIL`
- **Streamlit**: `SNOWMAIL.APP_SCHEMA.EMAIL_VIEWER`
- **Role**: `app_public`

### Permissions Required

The app requires:
- `USAGE` on `ACCELERATE_AI_IN_FSI`
- `USAGE` on `ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA`
- `SELECT, DELETE` on `ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA.EMAIL_PREVIEWS`
- `USAGE` on the compute warehouse

## Integration

### Email Procedure

The `SEND_EMAIL_NOTIFICATION` procedure automatically returns the SnowMail Native App URL:

```sql
CALL SEND_EMAIL_NOTIFICATION('Subject', 'Content', 'recipient@example.com');
```

Returns:
```
üìß VIEW YOUR EMAIL IN SNOWMAIL:
https://app.snowflake.com/{ORG}/{ACCOUNT}/apps/SNOWMAIL
```

### Pool Slug Template

The welcome page includes a direct button to SnowMail:

```markdown
‚ùÑÔ∏è SNOWMAIL - VIEW REPORTS
https://app.snowflake.com/{ORG}/{ACCOUNT}/apps/SNOWMAIL
```

## Updating the App

### Update Streamlit Code

1. Edit `streamlit/email_viewer.py`
2. Commit changes
3. Pipeline will automatically redeploy

### Update Version

To create a new version:

1. Update `manifest.yml` version number
2. Update version in `deploy_snowmail_native_app.template.sql`
3. Update version in pipeline YAML if needed
4. Commit and push

## Testing

Test the deployed app:

```bash
# Check app exists
snow sql --connection conn --query "SHOW APPLICATIONS LIKE 'SNOWMAIL';"

# Check Streamlit exists
snow sql --connection conn --query "SHOW STREAMLITS IN APPLICATION SNOWMAIL;"

# Test email creation
snow sql --connection conn --query "
CALL ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA.SEND_EMAIL_NOTIFICATION(
  'Test Email',
  '## Test Content',
  'test@example.com'
);
"
```

## Troubleshooting

### "Streamlit does not exist or not authorized"

Check permissions were granted:
```sql
GRANT USAGE ON DATABASE ACCELERATE_AI_IN_FSI TO APPLICATION SNOWMAIL;
GRANT USAGE ON SCHEMA ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA TO APPLICATION SNOWMAIL;
GRANT SELECT, DELETE ON TABLE ACCELERATE_AI_IN_FSI.DEFAULT_SCHEMA.EMAIL_PREVIEWS TO APPLICATION SNOWMAIL;
GRANT USAGE ON WAREHOUSE SI_DEMO_WH TO APPLICATION SNOWMAIL;
```

### App won't start

1. Check logs: `SHOW LOGS FOR APPLICATION SNOWMAIL;`
2. Verify all files uploaded: `LIST @{DB}_SNOWMAIL_PKG.APP_CODE.SNOWMAIL_STAGE;`
3. Check setup.sql executed successfully

### Version conflicts

Drop and recreate:
```sql
DROP APPLICATION IF EXISTS SNOWMAIL;
-- Then redeploy via pipeline
```

## Version History

- **V1.3**: Current version with full timestamps in inbox
- **V1.2**: Fixed permissions and warehouse access
- **V1.1**: Initial release with basic functionality
- **V1.0**: Beta version

## Support

For issues or questions:
- Check pipeline logs in GitLab CI/CD
- Review Snowflake account logs
- Contact: Snowflake Solutions Engineering team
